name: ğŸš€ Build & Deploy to Production

on:
  push:
    branches: [main]

# ========================================
# ğŸ”§ é¡¹ç›®é…ç½®å˜é‡ï¼ˆå¤ç”¨åˆ°å…¶ä»–é¡¹ç›®æ—¶åªéœ€ä¿®æ”¹è¿™é‡Œï¼‰
# ========================================
env:
  # é¡¹ç›®åŸºæœ¬ä¿¡æ¯
  PROJECT_NAME: portal-task-web # é¡¹ç›®åç§°ï¼ˆç”¨äºèµ„æºå‘½åï¼‰
  GITHUB_REPO: tt472625987/portal-task-web # GitHub ä»“åº“åœ°å€

  # é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡é…ç½®
  ACR_REGION: cn-chengdu # é˜¿é‡Œäº‘åœ°åŒº
  ACR_NAMESPACE: ray321 # é˜¿é‡Œäº‘ ACR å‘½åç©ºé—´
  ACR_REGISTRY_VPC: registry-vpc.cn-chengdu.aliyuncs.com # VPC å†…ç½‘åœ°å€ï¼ˆæ¨é€ç”¨ï¼‰
  ACR_REGISTRY_PUBLIC: registry.cn-chengdu.aliyuncs.com # å…¬ç½‘åœ°å€ï¼ˆK8s æ‹‰å–ç”¨ï¼‰

  # Kubernetes é…ç½®
  K8S_NAMESPACE: default # K8s å‘½åç©ºé—´
  K8S_DEPLOYMENT_FILE: deployment.yaml # K8s éƒ¨ç½²æ–‡ä»¶å

  # å¥åº·æ£€æŸ¥é…ç½®
  HEALTH_CHECK_PATH: /api/health # å¥åº·æ£€æŸ¥è·¯å¾„
  CONTAINER_PORT: 3000 # å®¹å™¨ç«¯å£

  # éƒ¨ç½²è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  ROLLOUT_TIMEOUT: 180

jobs:
  # =============================
  # 1ï¸âƒ£ æ„å»ºé•œåƒå¹¶æ¨é€åˆ°è…¾è®¯ TCR
  # =============================
  build:
    name: ğŸ—ï¸ Build & Push Docker Image
    runs-on: [self-hosted, linux, x64]

    outputs:
      image: ${{ steps.meta.outputs.image }}
      tag: ${{ steps.meta.outputs.tag }}

    steps:
      # æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_REPO }}
          fetch-depth: 0
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY || '' }}

      # ç¼“å­˜ Node æ¨¡å—ï¼ŒåŠ å¿« yarn install
      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            ~/.cache/yarn
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      # ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ ACRï¼ˆVPC å†…ç½‘åœ°å€ï¼Œç”¨äºæ¨é€ï¼‰
      - name: Login to Alibaba Cloud Container Registry (VPC)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY_VPC }}
          username: ${{ secrets.ALICLOUD_USERNAME }}
          password: ${{ secrets.ALICLOUD_PASSWORD }}

      # ç”Ÿæˆé•œåƒæ ‡ç­¾ï¼ˆæ„å»ºå· + commit çŸ­ç ï¼‰
      - name: Generate image metadata
        id: meta
        run: |
          # VPC å†…ç½‘åœ°å€ï¼ˆç”¨äºæ¨é€ï¼Œé€Ÿåº¦å¿«ä¸”å…æµé‡è´¹ï¼‰
          VPC_IMAGE=${{ env.ACR_REGISTRY_VPC }}/${{ env.ACR_NAMESPACE }}/${{ env.PROJECT_NAME }}
          # å…¬ç½‘åœ°å€ï¼ˆç”¨äº K8s æ‹‰å–ï¼ŒVPCå’Œå…¬ç½‘æŒ‡å‘åŒä¸€ä¸ªé•œåƒä»“åº“ï¼‰
          PUBLIC_IMAGE=${{ env.ACR_REGISTRY_PUBLIC }}/${{ env.ACR_NAMESPACE }}/${{ env.PROJECT_NAME }}

          # é•œåƒæ ‡ç­¾ï¼šbuild-æ„å»ºå·-commitçŸ­ç 
          # ä¾‹å¦‚ï¼šbuild-123-abc1234
          IMAGE_TAG="build-${GITHUB_RUN_NUMBER}-$(git rev-parse --short HEAD)"

          # è¾“å‡ºç»™åç»­æ­¥éª¤
          echo "image=$PUBLIC_IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "vpc_image=$VPC_IMAGE" >> $GITHUB_OUTPUT

          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: $IMAGE_TAG"
          echo "ğŸ“¤ æ¨é€åœ°å€: $VPC_IMAGE:$IMAGE_TAG"
          echo "ğŸ“¦ æ‹‰å–åœ°å€: $PUBLIC_IMAGE:$IMAGE_TAG"

      # æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆä½¿ç”¨ VPC å†…ç½‘æ¨é€ï¼Œé€Ÿåº¦æ›´å¿«ï¼‰
      - name: Build & Push Docker Image
        run: |
          VPC_IMAGE=${{ steps.meta.outputs.vpc_image }}
          PUBLIC_IMAGE=${{ steps.meta.outputs.image }}
          IMAGE_TAG=${{ steps.meta.outputs.tag }}

          echo "ğŸ›  æ„å»ºé•œåƒ: $VPC_IMAGE:$IMAGE_TAG"

          # æ„å»ºé•œåƒï¼ˆåª tag VPC åœ°å€ï¼‰
          docker build \
            --build-arg DATABASE_URL=${{ secrets.SUPABASE_POSTGRES_DATABASE_URL }} \
            --build-arg DIRECT_URL=${{ secrets.SUPABASE_POSTGRES_DIRECT_URL }} \
            -t $VPC_IMAGE:$IMAGE_TAG .

          echo "ğŸ“¤ æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘ ACR (VPC å†…ç½‘ï¼Œé€Ÿåº¦å¿«ä¸”å…æµé‡è´¹)..."
          docker push $VPC_IMAGE:$IMAGE_TAG

          echo "âœ… é•œåƒæ¨é€æˆåŠŸ"
          echo "   ğŸš€ æ¨é€åœ°å€: $VPC_IMAGE:$IMAGE_TAG"
          echo "   ğŸ“¦ K8sæ‹‰å–åœ°å€: $PUBLIC_IMAGE:$IMAGE_TAG"
          echo "   ğŸ’¡ æç¤º: VPCå’Œå…¬ç½‘åœ°å€æŒ‡å‘åŒä¸€ä¸ªé•œåƒï¼Œæ¨é€åˆ°VPCåå¯é€šè¿‡å…¬ç½‘è®¿é—®"

          # è¾“å‡ºç»™åç»­æ­¥éª¤
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE=$PUBLIC_IMAGE" >> $GITHUB_ENV

  # =============================
  # 2ï¸âƒ£ éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤
  # =============================
  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: [self-hosted, linux, x64]
    needs: build
    environment: production

    steps:
      # æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_REPO }}
          fetch-depth: 0
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY || '' }}

      # é…ç½® K8s è®¿é—®
      - name: Configure cluster access
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä½¿å…¶åœ¨åç»­æ‰€æœ‰æ­¥éª¤ä¸­ç”Ÿæ•ˆ
          echo "KUBECONFIG=$HOME/.kube/config" >> $GITHUB_ENV

          # æ˜¾ç¤ºé›†ç¾¤ API åœ°å€
          echo "ğŸ“ é›†ç¾¤ API åœ°å€ï¼š"
          kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}'
          echo ""

          # éªŒè¯é›†ç¾¤è¿æ¥
          echo "ğŸ” éªŒè¯é›†ç¾¤è¿æ¥..."
          kubectl cluster-info --request-timeout=10s
          echo "âœ… K8s é›†ç¾¤è¿æ¥æˆåŠŸ"

      # åŒæ­¥åº”ç”¨ Secrets åˆ° Kubernetes
      - name: Sync Application Secrets to Kubernetes
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: supabase-secret-${{ env.PROJECT_NAME }}
            namespace: ${{ env.K8S_NAMESPACE }}
          type: Opaque
          stringData:
            DATABASE_URL: "${{ secrets.SUPABASE_POSTGRES_DATABASE_URL }}"
            DIRECT_URL: "${{ secrets.SUPABASE_POSTGRES_DIRECT_URL }}"
          EOF
          echo "âœ… åº”ç”¨ Secrets å·²åŒæ­¥"

      # åˆ›å»ºé˜¿é‡Œäº‘é•œåƒæ‹‰å–å‡­è¯ï¼ˆè®©è…¾è®¯äº‘ K8s èƒ½æ‹‰å–é˜¿é‡Œäº‘ ACR é•œåƒï¼‰
      - name: Create Alibaba Cloud ACR Pull Secret
        run: |
          # åˆ é™¤æ—§çš„ secretï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          kubectl delete secret aliyun-acr-secret -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true

          # åˆ›å»ºæ–°çš„ docker-registry secret
          kubectl create secret docker-registry aliyun-acr-secret \
            --docker-server=${{ env.ACR_REGISTRY_PUBLIC }} \
            --docker-username="${{ secrets.ALICLOUD_USERNAME }}" \
            --docker-password="${{ secrets.ALICLOUD_PASSWORD }}" \
            --namespace=${{ env.K8S_NAMESPACE }}

          echo "âœ… é˜¿é‡Œäº‘é•œåƒæ‹‰å–å‡­è¯å·²åˆ›å»º"

      # æ›¿æ¢é•œåƒå¹¶éƒ¨ç½²
      - name: Apply deployment
        run: |
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}

          sed -i "s|__IMAGE_NAME__|$IMAGE|g" ${{ env.K8S_DEPLOYMENT_FILE }}
          sed -i "s|__IMAGE_TAG__|$TAG|g" ${{ env.K8S_DEPLOYMENT_FILE }}

          echo "ğŸš€ éƒ¨ç½²ç‰ˆæœ¬: $IMAGE:$TAG"
          kubectl apply -f ${{ env.K8S_DEPLOYMENT_FILE }}

      # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€å¹¶è‡ªåŠ¨å›æ»šï¼ˆé˜²æ­¢åç‰ˆæœ¬ï¼‰
      - name: Verify rollout & rollback if failed
        run: |
          DEPLOY_NAME=${{ env.PROJECT_NAME }}-deployment
          set -e
          if kubectl rollout status deployment/$DEPLOY_NAME --timeout=${{ env.ROLLOUT_TIMEOUT }}s; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
            kubectl rollout undo deployment/$DEPLOY_NAME
            echo "ğŸ©¹ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬"
            exit 1
          fi

      # éƒ¨ç½²å®Œæˆé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Notify Deployment Result
        if: always()
        run: |
          STATUS=${{ job.status }}
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}
          echo "ğŸ“¢ éƒ¨ç½²çŠ¶æ€: $STATUS"
          echo "ğŸ“¦ é•œåƒ: $IMAGE:$TAG"

      - name: Clean Docker BuildKit cache
        run: |
          docker builder prune -af
