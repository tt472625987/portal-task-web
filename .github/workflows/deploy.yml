name: ğŸš€ Build & Deploy to Production

on:
  push:
    branches: [main]

jobs:
  # =============================
  # 1ï¸âƒ£ æ„å»ºé•œåƒå¹¶æ¨é€åˆ°è…¾è®¯ TCR
  # =============================
  build:
    name: ğŸ—ï¸ Build & Push Docker Image
    runs-on: [self-hosted, linux, x64]

    outputs:
      image: ${{ steps.meta.outputs.image }}
      tag: ${{ steps.meta.outputs.tag }}

    steps:
      # æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: tt472625987/portal-task-web
          fetch-depth: 0
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY || '' }}

      # ç¼“å­˜ Node æ¨¡å—ï¼ŒåŠ å¿« yarn install
      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            ~/.cache/yarn
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      # ç™»å½•è…¾è®¯å®¹å™¨é•œåƒæœåŠ¡ TCR
      - name: Login to Tencent Container Registry
        uses: docker/login-action@v3
        with:
          registry: ccr.ccs.tencentyun.com
          username: ${{ secrets.TCR_USERNAME }}
          password: ${{ secrets.TCR_PASSWORD }}

      # ç”Ÿæˆè¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼ˆä¼˜å…ˆç”¨ Git tagï¼Œæ²¡æœ‰åˆ™ç”¨æ—¥æœŸ+commitï¼‰
      - name: Generate image metadata
        id: meta
        run: |
          IMAGE=ccr.ccs.tencentyun.com/ray321/portal-task-web
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            VERSION=$(git describe --tags --abbrev=0)
          else
            VERSION="v0.0.0-$(git rev-parse --short HEAD)"
          fi
          IMAGE_TAG="${VERSION}-$(date +%Y%m%d)"
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "ğŸ§© IMAGE=$IMAGE"
          echo "ğŸ§© TAG=$IMAGE_TAG"

      - name: Configure Docker builder
        run: |
          docker buildx create --use --name default --driver docker || true

      # æ„å»ºå¹¶æ¨é€é•œåƒï¼Œå¼€å¯ Docker å±‚ç¼“å­˜
      - name: Build & Push Docker Image
        run: |
          docker buildx build --builder default --load \
            --build-arg DATABASE_URL=${{ secrets.SUPABASE_POSTGRES_DATABASE_URL }} \
            --build-arg DIRECT_URL=${{ secrets.SUPABASE_POSTGRES_DIRECT_URL }} \
            -t $IMAGE:$IMAGE_TAG \
            --push .

  # =============================
  # 2ï¸âƒ£ éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤
  # =============================
  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: [self-hosted, linux, x64]
    needs: build
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # é…ç½® K8s è®¿é—®
      - name: Configure cluster access
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config
          echo "âœ… K8s é›†ç¾¤è¿æ¥æˆåŠŸ"

      # åŒæ­¥ Secrets åˆ° Kubernetes
      - name: Sync Secrets to Kubernetes
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: supabase-secret-portal-task-web
            namespace: default
          type: Opaque
          stringData:
            DATABASE_URL: "${{ secrets.SUPABASE_POSTGRES_DATABASE_URL }}"
            DIRECT_URL: "${{ secrets.SUPABASE_POSTGRES_DIRECT_URL }}"
          EOF
          echo "âœ… Secrets å·²åŒæ­¥"

      # æ›¿æ¢é•œåƒå¹¶éƒ¨ç½²
      - name: Apply deployment
        run: |
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}

          sed -i "s|__IMAGE_NAME__|$IMAGE|g" deployment.yaml
          sed -i "s|__IMAGE_TAG__|$TAG|g" deployment.yaml

          echo "ğŸš€ éƒ¨ç½²ç‰ˆæœ¬: $IMAGE:$TAG"
          kubectl apply -f deployment.yaml

      # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€å¹¶è‡ªåŠ¨å›æ»šï¼ˆé˜²æ­¢åç‰ˆæœ¬ï¼‰
      - name: Verify rollout & rollback if failed
        run: |
          DEPLOY_NAME=portal-task-web-deployment
          set -e
          if kubectl rollout status deployment/$DEPLOY_NAME --timeout=180s; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
            kubectl rollout undo deployment/$DEPLOY_NAME
            echo "ğŸ©¹ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬"
            exit 1
          fi

      # éƒ¨ç½²å®Œæˆé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Notify Deployment Result
        if: always()
        run: |
          STATUS=${{ job.status }}
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}
          echo "ğŸ“¢ éƒ¨ç½²çŠ¶æ€: $STATUS"
          echo "ğŸ“¦ é•œåƒ: $IMAGE:$TAG"
