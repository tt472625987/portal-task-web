name: Deploy to production

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Alibaba Cloud Container Registry
        uses: docker/login-action@v2
        with:
          registry: registry.cn-chengdu.aliyuncs.com
          username: ${{ secrets.ALICLOUD_USERNAME }}
          password: ${{ secrets.ALICLOUD_PASSWORD }}

      - name: Build and push Docker image
        run: |
          # ç”Ÿæˆå”¯ä¸€é•œåƒæ ‡ç­¾ (GitçŸ­æäº¤å“ˆå¸Œ + æ—¥æœŸ)
          IMAGE_TAG="$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
          PUBLIC_IMAGE=registry.cn-chengdu.aliyuncs.com/ray321/portal-task-web
          VPC_IMAGE=registry-vpc.cn-chengdu.aliyuncs.com/ray321/portal-task-web

          echo "ğŸ›  æ„å»ºé•œåƒæ ‡ç­¾: $IMAGE_TAG"

          # æ„å»ºå¹¶æ ‡è®°é•œåƒ (åŒæ—¶æ ‡è®°å…¬ç½‘)
          docker build \
            --build-arg DATABASE_URL=${{ secrets.SUPABASE_POSTGRES_DATABASE_URL }} \
            --build-arg DIRECT_URL=${{ secrets.SUPABASE_POSTGRES_DIRECT_URL }} \
            -t $PUBLIC_IMAGE:$IMAGE_TAG .

          # æ¨é€é•œåƒåˆ°å…¬ç½‘ä»“åº“
          docker push $PUBLIC_IMAGE:$IMAGE_TAG

          # ä¿å­˜æ ‡ç­¾ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "VPC_IMAGE=$VPC_IMAGE" >> $GITHUB_ENV

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Configure cluster access
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_B64" | base64 --decode > $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config

          echo "ğŸ§ª éªŒè¯é›†ç¾¤è¿æ¥..."
          kubectl cluster-info || { echo "âŒ é›†ç¾¤è¿æ¥å¤±è´¥"; exit 1; }

      - name: Deploy to Kubernetes
        run: |
          echo "::add-mask::$VPC_IMAGE"  # éšè—å†…ç½‘åœ°å€æ—¥å¿—
          echo "ğŸš€ æ­£åœ¨éƒ¨ç½²ç‰ˆæœ¬: $IMAGE_TAG"

          # æ›¿æ¢éƒ¨ç½²æ–‡ä»¶ä¸­çš„å ä½ç¬¦
          sed -i "s|__IMAGE_TAG__|$IMAGE_TAG|g" deployment.yaml
          sed -i "s|__IMAGE_NAME__|$VPC_IMAGE|g" deployment.yaml

          # å£°æ˜å¼åº”ç”¨é…ç½®
          kubectl apply -f deployment.yaml

          # ç­‰å¾…æ»šåŠ¨æ›´æ–°å®Œæˆ
          kubectl rollout status deployment/portal-task-web-deployment --timeout=180s || {
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼ŒæŸ¥çœ‹ Pod çŠ¶æ€ï¼š"
            kubectl get pods
            echo "âŒ æ–° Pod æ—¥å¿—å¦‚ä¸‹ï¼š"
            kubectl logs -l app=portal-task-web --tail=50
            exit 1
          }

          echo "âœ… éƒ¨ç½²å®Œæˆ"
