name: ğŸš€ Build & Deploy to Production

on:
  push:
    branches: [main]

jobs:
  # =============================
  # 1ï¸âƒ£ æ„å»ºé•œåƒå¹¶æ¨é€åˆ°è…¾è®¯ TCR
  # =============================
  build:
    name: ğŸ—ï¸ Build & Push Docker Image
    runs-on: [self-hosted, linux, x64]

    outputs:
      image: ${{ steps.meta.outputs.image }}
      tag: ${{ steps.meta.outputs.tag }}

    steps:
      # æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: tt472625987/portal-task-web
          fetch-depth: 0
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY || '' }}

      # ç¼“å­˜ Node æ¨¡å—ï¼ŒåŠ å¿« yarn install
      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            ~/.cache/yarn
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      # ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ ACRï¼ˆVPC å†…ç½‘åœ°å€ï¼Œç”¨äºæ¨é€ï¼‰
      - name: Login to Alibaba Cloud Container Registry (VPC)
        uses: docker/login-action@v3
        with:
          registry: registry-vpc.cn-chengdu.aliyuncs.com
          username: ${{ secrets.ALICLOUD_USERNAME }}
          password: ${{ secrets.ALICLOUD_PASSWORD }}

      # ç”Ÿæˆé•œåƒæ ‡ç­¾ï¼ˆæ„å»ºå· + commit çŸ­ç ï¼‰
      - name: Generate image metadata
        id: meta
        run: |
          # VPC å†…ç½‘åœ°å€ï¼ˆç”¨äºæ¨é€ï¼Œé€Ÿåº¦å¿«ä¸”å…æµé‡è´¹ï¼‰
          VPC_IMAGE=registry-vpc.cn-chengdu.aliyuncs.com/ray321/portal-task-web
          # å…¬ç½‘åœ°å€ï¼ˆç”¨äº K8s æ‹‰å–ï¼ŒVPCå’Œå…¬ç½‘æŒ‡å‘åŒä¸€ä¸ªé•œåƒä»“åº“ï¼‰
          PUBLIC_IMAGE=registry.cn-chengdu.aliyuncs.com/ray321/portal-task-web

          # é•œåƒæ ‡ç­¾ï¼šbuild-æ„å»ºå·-commitçŸ­ç 
          # ä¾‹å¦‚ï¼šbuild-123-abc1234
          IMAGE_TAG="build-${GITHUB_RUN_NUMBER}-$(git rev-parse --short HEAD)"

          # è¾“å‡ºç»™åç»­æ­¥éª¤
          echo "image=$PUBLIC_IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "vpc_image=$VPC_IMAGE" >> $GITHUB_OUTPUT

          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: $IMAGE_TAG"
          echo "ğŸ“¤ æ¨é€åœ°å€: $VPC_IMAGE:$IMAGE_TAG"
          echo "ğŸ“¦ æ‹‰å–åœ°å€: $PUBLIC_IMAGE:$IMAGE_TAG"

      # æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆä½¿ç”¨ VPC å†…ç½‘æ¨é€ï¼Œé€Ÿåº¦æ›´å¿«ï¼‰
      - name: Build & Push Docker Image
        run: |
          VPC_IMAGE=${{ steps.meta.outputs.vpc_image }}
          PUBLIC_IMAGE=${{ steps.meta.outputs.image }}
          IMAGE_TAG=${{ steps.meta.outputs.tag }}

          echo "ğŸ›  æ„å»ºé•œåƒ: $VPC_IMAGE:$IMAGE_TAG"

          # æ„å»ºé•œåƒï¼ˆåª tag VPC åœ°å€ï¼‰
          docker build \
            --build-arg DATABASE_URL=${{ secrets.SUPABASE_POSTGRES_DATABASE_URL }} \
            --build-arg DIRECT_URL=${{ secrets.SUPABASE_POSTGRES_DIRECT_URL }} \
            -t $VPC_IMAGE:$IMAGE_TAG .

          echo "ğŸ“¤ æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘ ACR (VPC å†…ç½‘ï¼Œé€Ÿåº¦å¿«ä¸”å…æµé‡è´¹)..."
          docker push $VPC_IMAGE:$IMAGE_TAG

          echo "âœ… é•œåƒæ¨é€æˆåŠŸ"
          echo "   ğŸš€ æ¨é€åœ°å€: $VPC_IMAGE:$IMAGE_TAG"
          echo "   ğŸ“¦ K8sæ‹‰å–åœ°å€: $PUBLIC_IMAGE:$IMAGE_TAG"
          echo "   ğŸ’¡ æç¤º: VPCå’Œå…¬ç½‘åœ°å€æŒ‡å‘åŒä¸€ä¸ªé•œåƒï¼Œæ¨é€åˆ°VPCåå¯é€šè¿‡å…¬ç½‘è®¿é—®"

          # è¾“å‡ºç»™åç»­æ­¥éª¤
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE=$PUBLIC_IMAGE" >> $GITHUB_ENV

  # =============================
  # 2ï¸âƒ£ éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤
  # =============================
  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: [self-hosted, linux, x64]
    needs: build
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # é…ç½® K8s è®¿é—®
      - name: Configure cluster access
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config
          echo "âœ… K8s é›†ç¾¤è¿æ¥æˆåŠŸ"

      # åŒæ­¥åº”ç”¨ Secrets åˆ° Kubernetes
      - name: Sync Application Secrets to Kubernetes
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: supabase-secret-portal-task-web
            namespace: default
          type: Opaque
          stringData:
            DATABASE_URL: "${{ secrets.SUPABASE_POSTGRES_DATABASE_URL }}"
            DIRECT_URL: "${{ secrets.SUPABASE_POSTGRES_DIRECT_URL }}"
          EOF
          echo "âœ… åº”ç”¨ Secrets å·²åŒæ­¥"

      # åˆ›å»ºé˜¿é‡Œäº‘é•œåƒæ‹‰å–å‡­è¯ï¼ˆè®©è…¾è®¯äº‘ K8s èƒ½æ‹‰å–é˜¿é‡Œäº‘ ACR é•œåƒï¼‰
      - name: Create Alibaba Cloud ACR Pull Secret
        run: |
          # åˆ é™¤æ—§çš„ secretï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          kubectl delete secret aliyun-acr-secret -n default --ignore-not-found=true

          # åˆ›å»ºæ–°çš„ docker-registry secret
          kubectl create secret docker-registry aliyun-acr-secret \
            --docker-server=registry.cn-chengdu.aliyuncs.com \
            --docker-username="${{ secrets.ALICLOUD_USERNAME }}" \
            --docker-password="${{ secrets.ALICLOUD_PASSWORD }}" \
            --namespace=default

          echo "âœ… é˜¿é‡Œäº‘é•œåƒæ‹‰å–å‡­è¯å·²åˆ›å»º"

      # æ›¿æ¢é•œåƒå¹¶éƒ¨ç½²
      - name: Apply deployment
        run: |
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}

          sed -i "s|__IMAGE_NAME__|$IMAGE|g" deployment.yaml
          sed -i "s|__IMAGE_TAG__|$TAG|g" deployment.yaml

          echo "ğŸš€ éƒ¨ç½²ç‰ˆæœ¬: $IMAGE:$TAG"
          kubectl apply -f deployment.yaml

      # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€å¹¶è‡ªåŠ¨å›æ»šï¼ˆé˜²æ­¢åç‰ˆæœ¬ï¼‰
      - name: Verify rollout & rollback if failed
        run: |
          DEPLOY_NAME=portal-task-web-deployment
          set -e
          if kubectl rollout status deployment/$DEPLOY_NAME --timeout=180s; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
            kubectl rollout undo deployment/$DEPLOY_NAME
            echo "ğŸ©¹ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬"
            exit 1
          fi

      # éƒ¨ç½²å®Œæˆé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Notify Deployment Result
        if: always()
        run: |
          STATUS=${{ job.status }}
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}
          echo "ğŸ“¢ éƒ¨ç½²çŠ¶æ€: $STATUS"
          echo "ğŸ“¦ é•œåƒ: $IMAGE:$TAG"

      - name: Clean Docker BuildKit cache
        run: |
          docker builder prune -af
